--- 

# Some resources

[–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å - C++ course notes](https://cpp-kt.github.io/cpp-notes/26_multithreading.html)

[–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ Thread Pool –≤ C++](https://habr.com/ru/articles/738250/)

# –ù–µ–º–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π

## Base terms

> –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –±—ã–ª–∞ –µ—â—ë –≤ –ü–≠–í–ú (–ü–ö), –≥–¥–µ –±—ã–ª –≤—Å–µ–≥–æ 1 –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (–∏ 1 –ø–æ—Ç–æ–∫). –ö–∞–∫ –æ–Ω–∞ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª–∞—Å—å? - –±—ã–ª –Ω–µ–∫–æ—Ç–æ—Ä—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –≤ –∫–∞–∫–∏–µ-—Ç–æ –º–æ–º–µ–Ω—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–ª—Å—è –Ω–∞ –¥—Ä—É–≥—É—é –∑–∞–¥–∞—á—É, –±—ã—Å—Ç—Ä–µ–Ω—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–ª—Å—è —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –µ—â—ë —á—Ç–æ-—Ç–æ –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ.
> 
- –ü–æ–¥–æ–±–Ω–æ–≥–æ —Ä–æ–¥–∞ –∏–º–∏—Ç–∞—Ü–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–∞–∫ **–ø—Å–µ–≤–¥–æ–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**.
- **–ú–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å** - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –ø—Å–µ–≤–¥–æ–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω—â–∏–Ω–∞) –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á
- **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å** - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞ —Å—á—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
- **–ü—Ä–æ—Ü–µ—Å—Å** - –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤ —Å–µ–±–µ:
    - –ø–æ—Ç–æ–∫–∏
    - –æ—Ç–∫—Ä—ã—Ç—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã (—Å–æ–∫–µ—Ç—ã, —Ñ–∞–π–ª—ã –∏ —Ç.–ø.)
    - –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    - –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
    - –∏ —Ç.–ø.

## **–ü–æ—Ç–æ–∫**

> –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: –ø–æ—Ç–æ–∫ - *–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –æ–±—â–µ–π –ø–∞–º—è—Ç—å—é, –Ω–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞–º–∏ –∏ —Å—Ç–µ–∫–æ–º*.
> 

<aside>
üí° –ß—É—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ –ø–æ—Ç–æ–∫–∏:

[Threads](threads.md)

</aside>

<aside>
üí°

–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —É –Ω–∞—Å –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–∑–Ω–∞—Ç—å, –∫–∞–∫–æ–π –ø–æ—Ç–æ–∫ –∫–∞–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–º–µ–µ—Ç –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ –∂–µ, —á—Ç–æ –æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç.

</aside>

---

# std::thread

> –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ –≤ –°++
> 

```cpp
std::thread t1([]{ 
	std::cout << "Do sth" << std::endl;
});
// –ù–∞ –ø–æ—Ç–æ–∫–µ t1 –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª—è–º–±–¥–∞
```

<aside>
üí°

–î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä std::thread –≤—ã–∑—ã–≤–∞–µ—Ç terminate()

</aside>

## join()

> –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ—Ç–æ–∫, –ø–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É
> 

```cpp
std::thread t1([]{ 
	std::cout << "Do sth" << std::endl;
});
// –º—ã, –∫–∞–∫ –≤—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ—Ç–æ–∫, –Ω–µ —Å–º–æ–∂–µ–º –≤—ã–∑–≤–∞—Ç—å –ø—Ä–∏–Ω—Ç –Ω–∏–∂–µ, 
// –ø–æ–∫–∞ t1 –Ω–µ –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç —Å–≤–æ–π –ø—Ä–∏–Ω—Ç
t.join(); 

std::cout << "finished" << std::endl;
```

## detach()

> –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–¥–µ–ª–∏—Ç—å –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø–æ—Ç–æ–∫ –æ—Ç –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ, –ø–æ–∑–≤–æ–ª—è—è —Ç–æ–º—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
> 

```cpp
std::thread t1([]{
	for (int i = 0; i < 150; ++i)
	{
		std::cout << "Did " << i << " cycle\n";
	}
});

t1.detach();
std::cout << "Main thread finished" << std::endl;
// –í –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∏–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∑–∞–∫–æ–Ω—á–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É –≥–¥–µ-—Ç–æ –ø–æ—Å—Ä–µ–¥–∏ —Å–ø–∞–º–∞ —á–∏—Å–µ–ª
// ... –∏–ª–∏ –µ—â—ë –¥–æ –Ω–µ–≥–æ
```

---

# std::mutex

[mutex](mutex.md)

---

# std::atomic

## atomic is‚Ä¶

> –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç, –≤–æ–ø–ª–æ—â–∞—é—â–∏–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
–ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è - –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –Ω–µ–¥–µ–ª–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–π –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –Ω–µ —Å–ø–æ—Å–æ–±–Ω—ã —É–≤–∏–¥–µ—Ç—å.
> 

–¢.–µ. —Ä–∞–∑–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –Ω–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∫–æ–≥–æ-–Ω–∏–±—É–¥—å, —É—Å–ª–æ–≤–Ω–æ, —Å–ª–æ–∂–µ–Ω–∏—è, –æ–Ω–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ ‚Äú–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ‚Äù –∏ ‚Äú–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Äù.

<aside>
üí°

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –í —Ä–∞–∑–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∞ –ø–æ-—Ä–∞–∑–Ω–æ–º—É.

</aside>

```cpp
static int v1 = 0;
static std::atomic<int> v2 { 0 };

int add_v1() 
{
    return ++v1;
    /* Generated x86-64 assembly:
        mov     eax, DWORD PTR v1[rip]       -> read
        add     eax, 1                       -> modify
        mov     DWORD PTR v1[rip], eax       -> write
    */
    // –¢.–µ.  –≤ —ç—Ç–æ–º —Ü–∏–ª–∫–µ –æ–ø–µ—Ä–∞—Ü–∏–π read-modify-write, –º–æ–∂–µ—Ç –≤–¥—Ä—É–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
    // –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫, —á—Ç–æ –≤ —Ü–µ–ª–æ–º –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ UB
}

int add_v2() 
{
    return v2.fetch_add(1);
    /* Generated x86-64 assembly:
        mov        eax, 1                               -> only modify
        lock xadd  DWORD PTR _ZL2v2[rip], eax
        ! –û–ø–µ—Ä–∞—Ü–∏—è lock –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –≥–∞—Ä–∞–Ω—Ç–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤
        ! —á—Ç–æ –∫ —Ç–µ–∫—É—â–µ–π –∫—ç—à –ª–∏–Ω–∏–∏, –≥–¥–µ –ª–µ–∂–∏—Ç v2, –º–æ–∂–µ—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ 1 —è–¥—Ä–æ
        ! * –ö—ç—à –ª–∏–Ω–∏—è - –ø—Ä–æ—Å—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ
        ! * * –ª–∏–Ω–∏—é –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å –∫–æ–Ω–≤–µ–µ—Ä–æ–º –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    */
}
```

## spinlock

> –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ–∫—Ü–∏–π –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–∫–µ. 
> –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É ‚Äúwhile(true) { —Å–ø–∏–º? ‚Üí –¥–∞ ‚Üí –∫—Ä—É—Ç–∏–º—Å—è –¥–∞–ª—å—à–µ } ‚Ä¶ { —Å–ø–∏–º? ‚Üí –ù–µ–∞, –≤—Å—Ç–∞–≤–∞–π –¥–∞–≤–∞–π ‚Üí –≤—ã—Ö–æ–¥ –∏–∑ while(true) ‚Üí –¥–µ–ª–∞–µ–º –¥–µ–ª–æ‚Äù
> 

<aside>
üí°

–ù–µ –∑–∞–±—ã–≤–∞–µ–º, —á—Ç–æ —Ç–∞–∫–æ–µ ‚Äú–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ‚Äù —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–µ, –Ω—É —Ç.–µ. –≤ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ç–æ–ª—å–∫–æ –∂–¥—ë—Ç –∏ –≤—Å—ë.

</aside>

```cpp
#include <atomic>

class spinlock final
{
    std::atomic_flag locked = ATOMIC_FLAG_INIT;
    
public:
    void lock() 
    {
		    //
        // –ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥, –ø–æ–∫–∞ –æ–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        //
        
        while (locked.test_and_set(std::memory_order_acquire))
        {
            // –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ, "–∫—Ä—É—Ç–∏–º—Å—è", –ø–æ–∫–∞ —Ñ–ª–∞–≥ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
        }
    }

    void unlock() 
    {
        locked.clear(std::memory_order_release);  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ñ–ª–∞–≥
    }
};
```

<aside>
üí°

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏—à—å –∫–æ–≥–¥–∞:

- –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π).
- –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ–±—ã—á–Ω–æ–≥–æ –º—å—é—Ç–µ–∫—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –ø–æ—Ç–æ–∫ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è) –≤—ã—à–µ, —á–µ–º –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ "–∫—Ä—É—á–µ–Ω–∏–µ" –≤ —Ü–∏–∫–ª–µ.
    - (–µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞ –ø–æ—á—Ç–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, —Ç–æ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ø–∏–Ω–ª–æ–∫ –º–æ–≥—É—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –Ω–∏–∂–µ, —á–µ–º –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ—Ç–æ–∫–∞ –≤ —Å–ø—è—â–∏–π —Ä–µ–∂–∏–º –∏ –µ–≥–æ –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ)
    - * mutex —É—Å—ã–ø–ª—è–µ—Ç –ø–æ—Ç–æ–∫, –∞ spinlock –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä ‚Äú–∞–∫—Ç–∏–≤–Ω–æ –∂–¥–∞—Ç—å‚Äù
</aside>

---

# std::condition_variable

> –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø—Ä–∏–º–∏—Ç–∏–≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ø—Ä–æ–±—É–∂–¥–∞—Ç—å –ø–æ—Ç–æ–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ ‚Äú–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è‚Äù.

```cpp
#include <iostream>
#include <thread>
#include <mutex>
#include <deque>
#include <condition_variable>

using lock_guard_t = std::lock_guard<std::mutex>;
using uniq_guard_t = std::unique_guard<std::mutex>;

template <typename T>
struct concurrent_queue 
{
    void push(T value) 
	  {
        uniq_guard_t lg(m);
        q.push_back(std::move(value));
        lg.unlock();
        
        // –≠—Ç–æ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ–¥–∏–Ω –∏–∑ –ø–æ—Ç–æ–∫–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –≤ pop, –æ —Ç–æ–º, 
        // —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∏ –µ–≥–æ –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å.
        cv.notify_one();  
    }
    
    T pop() 
    {
        uniq_guard_t ul(m);
        
        // –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫ –æ–∂–∏–¥–∞—Ç—å, –ø–æ–∫–∞ —É—Å–ª–æ–≤–∏–µ (–æ—á–µ—Ä–µ–¥—å –Ω–µ –ø—É—Å—Ç–∞) –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è.
        // –ö–æ–≥–¥–∞ —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç 
        // .. —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏.
        cv.wait(ul, [this]{ 
	        return !q.empty(); 
	      });
	      
        T result = q.front();
        q.pop_front();
        return result;
    }

    bool empty() const 
    {
        lock_guard_t lg(m);
        return q.empty();
    }

private:
    mutable std::mutex m;
    std::deque<T> q;
    std::condition_variable cv;  // –£—Å–ª–æ–≤–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
};
```

<aside>
üí°

–£ –Ω–µ–≥–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:

- wait - –ø–æ—Ç–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–ø–∞—Ç—å
- notify_one - –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –æ–¥–∏–Ω –ø–æ—Ç–æ–∫
    - –ü—Ä–æ–±—É–∂–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ—Ç 1 –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–≤–∞–ª  wait(), –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –∏–∑ –ø–∞—á–∫–∏ –ø–æ—Ç–æ–∫–æ–≤ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, —Å—Ç–∞–Ω–¥–∞—Ä—Ç –Ω–∏—á–µ–≥–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ —è–≤–Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç
- notify_all - –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –≤—Å–µ –ø–æ—Ç–æ–∫–∏ (–≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ—Ç–æ–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å wait)
</aside>

<aside>
üí°

`wait` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ `unique_lock`. –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –º–µ–∂–¥—É `unlock` –∏ –≤—ã–∑–æ–≤–æ–º `wait` –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏–ª. 

</aside>

---

# memory order

[memory order](memory-order.md)

---

# –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ –ø–æ—Ç–æ–∫–∏ - –∫–æ–Ω–µ—Ü –∏ —á—Ç–æ –≤—Å—ë –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø–æ–Ω—è–ª, —Ç–æ –∫—É—à–∞–π:

```cpp
#include <iostream>
#include <thread>
#include <vector>
#include <queue>
#include <functional>
#include <mutex>
#include <condition_variable>
#include <future>

class ThreadPool final
{
public:
    ThreadPool(size_t numThreads);
    ~ThreadPool();

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å
    template<class F, class... Args>
    auto enqueue(F&& f, Args&&... args) 
		    -> std::future<typename std::result_of<F(Args...)>::type>;

private:
    // –í–µ–∫—Ç–æ—Ä —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
    std::vector<std::thread> workers;
    // –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á
    std::queue<std::function<void()>> tasks;

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    std::mutex queueMutex;
    std::condition_variable condition;
    bool stop;

    // –†–∞–±–æ—á–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤
    void worker();
};

ThreadPool::ThreadPool(size_t numThreads) 
		: stop(false) 
{
    for (size_t i = 0; i < numThreads; ++i) 
    {
        workers.emplace_back([this]{ 
		        this->worker(); 
		    });
    }
}

ThreadPool::~ThreadPool() 
{
    {
        std::unique_lock<std::mutex> lock(queueMutex);
        stop = true;
    }
    
    condition.notify_all();
    for (std::thread &worker : workers) 
    {
        worker.join();
    }
}

void ThreadPool::worker() 
{
    while (true) 
    {
        std::function<void()> task;
        
        {
            std::unique_lock<std::mutex> lock(queueMutex);
            condition.wait(lock, [this]{ 
		            return stop || !tasks.empty();
		        });
		        
            if (stop && tasks.empty())
            {
                return;
            }
            
            task = std::move(tasks.front());
            tasks.pop();
        }
        
        task();
    }
}

template<class F, class... Args>
auto ThreadPool::enqueue(F&& f, Args&&... args) 
		-> std::future<typename std::result_of<F(Args...)>::type>
{
    using return_type = typename std::result_of<F(Args...)>::type;

    auto task = std::make_shared<std::packaged_task<return_type()>>(
        std::bind(std::forward<F>(f), std::forward<Args>(args)...)
    );

    std::future<return_type> result = task->get_future();
    
    {
        std::unique_lock<std::mutex> lock(queueMutex);
        tasks.emplace([task]() { (*task)(); });
    }
    
    condition.notify_one();
    return result;
}

int main() 
{
    ThreadPool pool(4);

    auto result1 = pool.enqueue([] { return 1; });
    auto result2 = pool.enqueue([] { return 2 + 2; });

    std::cout << result1.get() << std::endl;  // –í—ã–≤–µ–¥–µ—Ç: 1
    std::cout << result2.get() << std::endl;  // –í—ã–≤–µ–¥–µ—Ç: 4

    return 0;
}

```