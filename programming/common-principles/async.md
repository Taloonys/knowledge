# Usual anatomy

![Untitled](programming/common-principles/image-storage/Untitled%2015.png)

üí° –ù–∞–ø–∏—Å–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –Ω–∏–∂–µ, —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏

- Io object
    
    > –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –Ω–µ–∫–æ—Ç–æ—Ä—ã–π api, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ Io service, –∞-–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å send, recieve –∏ —Ç.–ø., —á–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è–º–∏ —Ç–∞–∫–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Ü–∏–∏ —è–≤–ª—è—é—Ç—Å—è —Å–æ–∫–µ—Ç—ã, acceptor‚Äô—ã, resolver‚Äô—ã –∏ —Ç.–ø.
    > 
- Io service
    
    > –°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ä–æ–¥–∞ —É–ø–∞–∫–æ–≤–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ —Å Io object‚Äô–∞ –≤, –≥—Ä—É–±–æ –≥–æ–≤–æ—Ä—è, –ø–∞—Ä—ã ID ‚Üî Handler, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ç–æ–º –ø–µ—Ä–µ–¥–∞—Å—Ç –≤ Io context
    > 
- Io context
    
    > –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –∏–∑ –ø–∞—Ä ID ‚Üî Handler –∏ –∏—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    > 
    
    [Chapter¬†32.¬†Boost.Asio - I/O Services and I/O Objects](https://theboostcpplibraries.com/boost.asio-io-services-and-io-objects)
    

# Future and Promise

> –≠—Ç–æ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ –º–µ–∂-–ø–æ—Ç–æ—á–Ω–æ–µ –∏–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ. –≠—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞ –≤ –ø–∞—Ä–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É - ‚Äú–ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –±—É–¥—É‚Äù –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–∏–º–µ—Ä:

```cpp
#define BOOST_THREAD_PROVIDES_FUTURE
#include <boost/thread.hpp>
#include <boost/thread/future.hpp>
#include <functional>
#include <iostream>

// –í—ã—á–∏—Å–ª—è–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Å—É–º–º—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–µ—â–∞–Ω–∏–µ
void Accumulate(boost::promise<int> &p)
{
  int sum = 0;
  for (int i = 0; i < 5; ++i)
  {
    sum += i;
  }
  
  p.set_value(sum); // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º integer –≤ –æ–±–µ—â–∞–Ω–∏–µ
}

int main()
{
	// 1. "–æ–±–µ—â–∞–µ–º", —á—Ç–æ –±—É–¥–µ—Ç integer
  boost::promise<int> p; 
  
  // 2. —Å–≤—è–∑—ã–≤–∞–µ–º "–æ–±–µ—â–∞–Ω–∏–µ" –∏ "–±—É–¥—É—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é"
  boost::future<int> f = p.get_future(); 
  
  // 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é Accumulate –≤ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫, –∏ –ø–µ—Ä–µ–¥–∞—ë–º –µ–º—É —Å—Å—ã–ª–∫—É –Ω–∞ "–æ–±–µ—â–∞–Ω–∏–µ"
  boost::thread t{Accumulate, std::ref(p)}; 
  
  // 5. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ "–±—É–¥—É—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π" –∑–Ω–∞—á–µ–Ω–∏–µ
  // –ü–æ—á–µ–º—É –ø—ã—Ç–∞–µ–º—Å—è –∏ –ø—Ä–∏ —á—ë–º —Ç—É—Ç "–±—É–¥—É—â–µ–µ" ?
  // –≤—ã–∑–æ–≤ get() –±–ª–æ–∫–∏—Ä—É—é—â–∏–π, –ø–æ–∫–∞ –≤ –Ω–µ–≥–æ –Ω–µ –ø–æ–º–µ—Å—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ,
  // —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
  std::cout << f.get() << '\n';
}
```

---

# Async wait

> –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É wait –∏ await ‚Üí wait –æ–±—ã—á–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ—Ç–æ–∫, –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç/–æ—Ç–≤–µ—Ç, –∞ await, —É—Å–ª–æ–≤–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–π (—Ç–∞–º –µ—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –æ—Å-–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏

---

# Prepare/Commit for buffers

–í–æ–∑—å–º—É –≤ –ø—Ä–∏–º–µ—Ä, boost::asio –±—É—Ñ—Ñ–µ—Ä—ã, –≥–¥–µ –µ—Å—Ç—å buffer, mutable_buffer, dynamic_buffer –∏ —Ç.–ø. –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö —Å–æ–∫–µ—Ç–æ–≤. –û–Ω–∏ –≤—Å–µ –º–æ–≥—É—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤ —Å–µ–±—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ç–∏–ø–∞ –≤–µ–∫—Ç–æ—Ä–∞, –¥–∞–±—ã –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–µ —Ä–µ–∞–ª–æ–∫–µ–π—Ç–∏—Ç—å –ø–∞–º—è—Ç—å, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ –≤—Å—ë –≤–æ–æ–±—â–µ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏‚Ä¶

```cpp
  // d_duff - –ø—Ä–æ—Å—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –±—É—Ñ—Ñ–µ—Ä, –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è MutableSequence, 
  // —Ç.–µ. –Ω–µ–ª—å–∑—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –µ–≥–æ –Ω–∞—á–∞–ª—É –∏ —á—ë —Ç –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å
  auto d_buff = boost::asio::dynamic_buffer(buffer_);
  
  // 
  auto completion_token = 
	  [&d_buff,
     lifetime = shared_from_this(), 
		 handler  = std::move(external_handler)]
			 (const bsys::error_code& ec, std::size_t bytes_transferred) mutable { 
			 // async_receive –ø–æ–¥—Å—É–Ω–µ—Ç –Ω—É–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ç–∞–∫—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É c ec –∏ bytes_transferred
	  //...
	  d_buff.commit(bytes_transferred); 
	  // –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ç–æ –∫–æ–ª-–≤–æ –±–∞–π—Ç, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ –∏—Ç–æ–≥—É –±—ã–ª–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –∏ "–æ—Ç–ø—É—Å–∫–∞–µ—Ç" –ª–∏—à–Ω–µ–µ
  }
  
  // prepare –∑–∞—Ä–∞–Ω–µ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–ª-–≤–µ –±–∞–π—Ç
  // –∏ –≤–æ–∑—Ä–∞—â–∞–µ—Ç MutableSequence, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–µ—Ç–æ–¥—É —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ–∫–µ—Ç–∞
  spp_soc_t::async_receive(d_buff.prepare(4096),
                           flags, 
                           std::move(completion_token));
```

–î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º –≤—ã–∑–æ–≤ resize, dynamic_buffer –∏–º–µ–Ω–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ resize() –¥–µ–ª–∞–µ—Ç –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏