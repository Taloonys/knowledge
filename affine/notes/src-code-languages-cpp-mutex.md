---
tags: [code, languages, cpp]
aliases: [Mutex is‚Ä¶]
---

# lock_guard
> –ö–∞–∫ –∏ –¥–ª—è –ª—é–±–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ‚Äú–æ—Ç–∫—Ä—ã—Ç—å - –∑–∞–∫—Ä—ã—Ç—å‚Äù, —É –º—å—é—Ç–µ–∫—Å–∞ –µ—Å—Ç—å –æ–±—ë—Ä—Ç–∫–∞ RAII

[RAII](raii.md)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º—å—é—Ç–µ–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –º—å—é—Ç–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ö–≤–∞—á–µ–Ω –Ω–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ –ø–µ—Ä–µ–¥–∞—á—É –≤–ª–∞–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–æ–º.

```cpp
//
// –ü—Ä–∏–º–µ—Ä —Ä–∞–Ω–µ–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–∞–∫:
//

std::mutex mut;

void Increment()
{ 
    std::lock_guard lock(mut);
    
    for (int i = 0; i < 1000000; i++)
    { 
        number++;
    } 
}
```
üí°

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç unique_lock, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ, —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–±–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ—á–∏—Ç—å 1 –º—å—é—Ç–µ–∫—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ —Ä–∞–∑–ª–æ—á–∏–≤–∞—Ç—å –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏, –∏ —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã, —Ç.–µ. –æ–±–ª–∞—Å—Ç—å—é –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–∞–∫–æ–π RAII –æ–±—ë—Ä—Ç–∫–∏ —è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫–∞—è-–Ω–∏–±—É–¥—å –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## unique_lock
> –≠—Ç–æ –±–æ–ª–µ–µ–µ –ø—Ä–æ–∫–∞—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è lock_guard, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –∫–æ–≥–¥–∞ —É–≥–æ–¥–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å, —Ç–∞–∫–∂–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–æ–º –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å.

```cpp
std::mutex mtx;
void Critical_section()
{
    std::unique_lock<std::mutex> lock(mtx);   	// –ó–∞—Ö–≤–∞—Ç –º—å—é—Ç–µ–∫—Å–∞

    //
    // –ö–æ–¥ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
    //

    lock.unlock(); 				// –Ø–≤–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞

    //
    // –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥
    //

    lock.lock(); 				// –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞

    //
    // –°–Ω–æ–≤–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥
    //
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –º—å—é—Ç–µ–∫—Å —Å—Ä–∞–∑—É).
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –≤–ª–∞–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–æ–º –¥—Ä—É–≥–æ–º—É `unique_lock`.
- –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `lock_guard` –∏–∑-–∑–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏.

## scoped_lock (C++17)
> –ú–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ —Å—Ä–∞–∑—É**, **–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è deadlock**. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é **–∞—Ç–æ–º–∞—Ä–Ω–æ**.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ deadlock.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º—å—é—Ç–µ–∫—Å–∞.
- –û—á–µ–Ω—å —É–¥–æ–±–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º—å—é—Ç–µ–∫—Å–∞–º–∏.

```cpp
std::mutex mtx1, mtx2;
void critical_section() 
{
    std::scoped_lock lock(mtx1, mtx2);
    //
    // <-- –ö–æ–¥ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏, –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –¥–≤—É–º—è –º—å—é—Ç–µ–∫—Å–∞–º–∏
    //
}
```
üí°
–í—Å–ø–æ–º–∏–Ω–∞—è –ø—Ä–∏–º–µ—Ä –∏–∑ –≥–ª–∞–≤—ã –ø—Ä–æ **deadlock**, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–ø–µ—Ä—å –≤–æ—Ç —Ç–∞–∫:

```cpp
std::mutex mtx1;
std::mutex mtx2;

void thread1() 
{
    std::scoped_lock lock(mtx1, mtx2); 				// –ó–∞—Ö–≤–∞—Ç –æ–±–æ–∏—Ö –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ
    std::cout << "Thread 1 has locked both mutexes.\n";
}

void thread2() 
{
    std::scoped_lock lock(mtx1, mtx2); 				// –ó–∞—Ö–≤–∞—Ç –æ–±–æ–∏—Ö –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ
    std::cout << "Thread 2 has locked both mutexes.\n";
}

// int main...
```

## shared_mutex & shared_lock
> shared_mutex –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ **–ª–∏—à—å 1 –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**, –∞  **–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ª–∏—à—å —á–∏—Ç–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.**

```cpp
#include <iostream>
#include <thread>
#include <shared_mutex>
#include <map>
#include <string>

std::shared_mutex cache_mutex;
std::map<int, std::string> cache;

using shared_lock_t = std::shared_lock<std::shared_mutex>;
using unique_lock_t = std::unique_lock<std::unique_mutex>;

std::string GetFromCache(int key) 
{
    //
    // –ó–∞—Ö–≤–∞—Ç –≤ —Ä–µ–∂–∏–º–µ shared (–¥–ª—è —á—Ç–µ–Ω–∏—è)
    //

    shared_lock_t lock(cache_mutex); 
    if (cache.find(key) != cache.end()) {
        return cache[key]; 			// If found by key
    } 
    else {
        return "Not found";
    }
}

void UpdateCache(int key, const std::string& value) 
{
    //
    // –ó–∞—Ö–≤–∞—Ç –≤ —Ä–µ–∂–∏–º–µ exclusive (–¥–ª—è –∑–∞–ø–∏—Å–∏)
    // –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ-—Ç–æ
    // .. –ø–æ–∫–∞ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –ø–æ—Ç–æ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç
    // .. —Ç.–µ. –≤—Å–µ –ø–æ—Ç–æ–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é –¥—Ä—É–≥ –¥—Ä—É–≥–∞
    // .. –Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å–µ–º —á–∏—Ç–∞—Ç—å
    // .. –ø–æ–∫–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ, –∞ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ —Ä–∞–∑—Ä–µ—à–∞—Ç –≤—Å–µ–º —á–∏—Ç–∞—Ç—å –¥–∞–ª—å—à–µ
    //

    unique_lock_t lock(cache_mutex);
    cache[key] = value;
}

void reader_thread(int key) 
{
    std::cout << "Reader thread: " << GetFromCache(key) << std::endl;
}

void writer_thread(int key, const std::string& value) 
{
    UpdateCache(key, value);
    std::cout << "Writer thread: updated key " << key  
              << " with value " << value << std::endl;
}

int main() 
{
    //
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
    //

    std::thread writer1(writer_thread, 1, "Data1");
    writer1.join();

    //
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞
    //

    std::thread reader1(reader_thread, 1);
    std::thread reader2(reader_thread, 1);
    reader1.join();
    reader2.join();

    //
    // –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º
    //

    std::thread writer2(writer_thread, 1, "NewData1");
    writer2.join();

    //
    // –ß—Ç–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    //

    std::thread reader3(reader_thread, 1);
    reader3.join();

    return 0;
}
```

–ï—Å–ª–∏ –±—ã –≤ –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–±—ã—á–Ω—ã–π –º—å—é—Ç–µ–∫—Å, —Ç–æ —á—Ç–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –±—ã –∫—É–¥–∞ –¥–æ–ª—å—à–µ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —á—Ç–µ–Ω–∏–µ –∫–∞–∂–¥—ã–º –ø–æ—Ç–æ–∫–æ–º –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –±—ã –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏.

## recursive_mutex
> –≠—Ç–æ –º—å—é—Ç–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ö–≤–∞—á–µ–Ω –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –ø–æ—Ç–æ–∫–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è. –ü–æ–ª–µ–∑–µ–Ω –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è, —É–∂–µ –∑–∞—Ö–≤–∞—Ç–∏–≤—à–∞—è –º—å—é—Ç–µ–∫—Å, –≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Ç–æ—Ç –∂–µ –º—å—é—Ç–µ–∫—Å.

```cpp
std::recursive_mutex rec_mtx;

void RecursiveFunction(int count) 
{
    if (count <= 0) {
      return;
    } 
    
    std::lock_guard<std::recursive_mutex> lock(rec_mtx);
    std::cout << "Count: " << count << std::endl;
    
    RecursiveFunction(count - 1);
}

int main() 
{
    std::thread t1(RecursiveFunction, 3);
    t1.join();
}

```

## ‚Ä¶add
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º—å—é—Ç–µ–∫—Å–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö –∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∫—É–¥–∞ –±–æ–ª—å—à–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ Win32 Api –µ—Å—Ç—å SRWLock, –≤ UNIX - pthread_mutex, futex, pthread_rwlocck –∏ —Ç.–ø.
