# Mutex is‚Ä¶

> **Mutual exclusion (–≤–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)** - –º–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∑–∞—â–∏—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º, –æ—Ç –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–æ–∫–æ–≤.
- lock()
    > –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫, —Ç.–µ. –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –º–µ—Ç–æ–¥, –∏–º–µ–µ—Ç —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –Ω–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∞ –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è.
- unlock()
    > –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ lock(), –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–æ—Ç–æ–∫ –æ—Ç –∑–∞—Ö–≤–∞—Ç–∞.

```cpp
std::mutex mtx;                         // –û–ø–∏—Å–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
int number = 0; 
  
void Increment()
{ 
    mtx.lock();                         // —Å—é–¥–∞ –∑–∞–π–¥—É—Ç –∏ t1 –∏ t2, –Ω–æ –º—ã –Ω–µ –∑–Ω–∞–µ–º —Ç–æ—á–Ω–æ –∫—Ç–æ –∏ –∫–æ–≥–¥–∞
    
    for (int i = 0; i < 1000000; i++)
    { 
        number++;                       // –∫–∞–∫–∞—è-—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    } 
      
    mtx.unlock();                       // –ø–æ—Ç–æ–∫, —á—Ç–æ —É—Å–ø–µ–ª –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥, –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥—Ä—É–≥–æ–º—É —Å–¥–µ–ª–∞—Ç—å —Å–≤–æ—ë –¥–µ–ª–æ
} 
  
int main() 
{ 
    std::thread t1(Increment); 
    std::thread t2(Increment); 
      
    t1.join(); 
    t2.join(); 
      
    std::cout << "Number after execution of t1 and t2 is "<< number; 
      
    return 0; 
} 

```


mutex, –∫–∞–∫ —Ç–∏–ø –≤–Ω—É—Ç—Ä–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –º–Ω–æ–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. 
–û–Ω –∫–∞–∫ –±—ã —è–≤–ª—è–µ—Ç—Å—è –æ–ø–∏—Å–∞—Ç–µ–ª–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ –∂–µ –º–æ–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –∫–∞–∫ std::atomic_bool, –≥–¥–µ –ø–æ—Ç–æ–∫–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç, –º–æ–≥—É—Ç –ª–∏ –æ–Ω–∞ —â–∞—Å –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–ª–∏ –Ω–µ—Ç:

- –∫–∞–∫–æ–π-—Ç–æ –∏–∑ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞—à—ë–ª –≤ –∫–æ–¥, –ø–µ—Ä–µ–∫–ª—é—á–∏–ª –º—å—é—Ç–µ–∫—Å –Ω–∞ ‚Äú–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è‚Äù
- –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –∑–∞—à–ª–∏ –≤ –∫–æ–¥, —Å–ø—Ä–æ—Å–∏–ª–∏ ‚Äú–∑–∞–Ω—è—Ç –ª–∏ –∫–µ–º-—Ç–æ –º—å—é—Ç–µ–∫—Å
- –∂–¥—É—Ç –ø–æ–∫–∞ –º—å—é—Ç–µ–∫—Å ‚Äú–æ—Å–≤–æ–±–æ–¥—è—Ç
- –∫–æ–≥–¥–∞ –º—å—é—Ç–µ–∫—Å –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è ‚Üí –∫–∞–∫–æ–π-—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π 1 –ø–æ—Ç–æ–∫ —É—Å–ø–µ–≤–∞–µ—Ç –∑–∞–ª–µ—Ç–µ—Ç—å
- ... –≤—Å—ë –ø–æ –Ω–æ–≤–æ–π

# Race condition
> –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–¥–∞—á–µ–π –º—å—é—Ç–µ–∫—Å —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ç–∞–∫–æ–≥–æ undefined behaviour (UB) –∫–∞–∫ **race condition (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏)**, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è, –∞ –¥—Ä—É–≥–∏–º –≤ —ç—Ç–æ—Ç –∂–µ –º–æ–º–µ–Ω—Ç —Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è.

# mutex/lock granularity
> –≠—Ç–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è, –æ–ø–∏—Å—ã–≤–∞—é—â–∞—è, –æ–±—ä—ë–º –∫–æ–¥–∞, –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º—å—é—Ç–µ–∫—Å–æ–º‚Ä¶

## Coarse-grained locking
> –ü—Ä–∏ –≥—Ä—É–±–æ–π –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –º—å—é—Ç–µ–∫—Å –∑–∞—â–∏—â–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–π –∫—É—Å–æ–∫ –∫–æ–¥–∞

```cpp
std::mutex mtx;
std::array<int, 1000> accounts;

void Transfer(size_t to, size_t from, int amount) 
{
    mtx.lock();
    
    if (accounts[from] < amount) 
    {
        m.unlock();
        throw std::runtime_error("insufficient funds");
    }
    
    accounts[from] -= amount;
    accounts[to]   += amount;
    
    mtx.unlock();
}
```

–ú–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–æ—Ç–æ–∫–∏ –≤—ã–Ω—É–∂–¥–µ–Ω—ã –∂–¥–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ –¥–∞–Ω–Ω—ã—Ö. –û–¥–Ω–∞–∫–æ –∫–æ–¥ –∫—É–¥–∞ –ø—Ä–æ—â–µ –ø–æ–Ω—è—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–∏—Ä–æ–≤–∞—Ç—å.

## Fine-grained locking
> –ü—Ä–∏ —Ç–æ–Ω–∫–æ–π –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤, –∑–∞—â–∏—â–∞—é—â–∏—Ö –∫–∞–∫ –º–æ–∂–Ω–æ –º–µ–Ω—å—à–∏–µ –∫—É—Å–∫–∏ –∫–æ–¥–∞‚Ä¶

```cpp
struct account {
    std::mutex  mtx;
    int32_t     balance;
};

using lock_guard_t = std::lock_guard<std::mutex>;

std::array<account, 1000> accounts;

void Transfer(size_t to, size_t from, int amount) 
{
    lock_guard_t lg_from(accounts[from].mtx);
    lock_guard_t lg_to(accounts[to].mtx);
    
    if (accounts[from].balance < amount) 
    {
        throw std::runtime_error("insufficient funds");
    }
    
    accounts[from].balance -= amount;
    accounts[to].balance   += amount;
}
```

–ú–æ–∂–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞ —Å—á—ë—Ç –ª—É—á—à–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–∏, –Ω–æ —Ü–µ–Ω–∞ —ç—Ç–æ–≥–æ ‚Äî —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π, —Ç–∞–∫–∏–µ –∫–∞–∫ deadlock.

# deadlock
> –≠—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –¥–≤–∞ –ø–æ—Ç–æ–∫–∞ –ø—ã—Ç–∞—é—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –¥–≤–∞ –º—å—é—Ç–µ–∫—Å–∞ –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –∏–∑-–∑–∞ —á–µ–≥–æ –º–æ–≥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –õ—É—á—à–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä:

```cpp
#include <iostream>
#include <thread>
#include <mutex>

std::mutex mtx1;
std::mutex mtx2;

using namespace std::chrono_literals; 			// * –¥–ª—è —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–∏

void thread1() 
{
    std::lock_guard<std::mutex> lock1(mtx1);
    std::this_thread::sleep_for(50ms);       		// –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã

    //
    // –ü–æ—Ç–æ–∫ 1 –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å mtx2, –Ω–æ –æ–Ω —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω –ø–æ—Ç–æ–∫–æ–º 2, 
    // –ø–æ—ç—Ç–æ–º—É –ø–æ—Ç–æ–∫ 1 –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –æ–∂–∏–¥–∞—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è mtx2
    //
    std::lock_guard<std::mutex> lock2(mtx2);

    std::cout << "Thread 1 has locked both mutexes.\n";
}

void thread2() 
{
    std::lock_guard<std::mutex> lock1(mtx2);
    std::this_thread::sleep_for(50ms);       		// –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã

    //
    // –ü–æ—Ç–æ–∫ 2 –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å mtx1, –Ω–æ –æ–Ω —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω –ø–æ—Ç–æ–∫–æ–º 1, 
    // –ø–æ—ç—Ç–æ–º—É –ø–æ—Ç–æ–∫ 2 –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –æ–∂–∏–¥–∞—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è mtx1
    //
    std::lock_guard<std::mutex> lock2(mtx1);

    std::cout << "Thread 2 has locked both mutexes.\n";
}

int main() 
{
    std::thread t1(thread1);
    std::thread t2(thread2);
    
    //
    // –í –∏—Ç–æ–≥–µ –æ–±–∞ –ø–æ—Ç–æ–∫–∞ –∂–¥—É—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞
    // —Ç.–µ. –æ–Ω–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏...
    //

    t1.join();
    t2.join();

    return 0;
}
```

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω–æ–≥–æ —Ä–æ–¥–∞ –ø—Ä–æ–±–ª–µ–º—ã, –µ—Å—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, std::scoped_lock

# lock_guard
> –ö–∞–∫ –∏ –¥–ª—è –ª—é–±–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ‚Äú–æ—Ç–∫—Ä—ã—Ç—å - –∑–∞–∫—Ä—ã—Ç—å‚Äù, —É –º—å—é—Ç–µ–∫—Å–∞ –µ—Å—Ç—å –æ–±—ë—Ä—Ç–∫–∞ RAII

[RAII](raii.md)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º—å—é—Ç–µ–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ).
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –º—å—é—Ç–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ö–≤–∞—á–µ–Ω –Ω–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ –ø–µ—Ä–µ–¥–∞—á—É –≤–ª–∞–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–æ–º.

```cpp
//
// –ü—Ä–∏–º–µ—Ä —Ä–∞–Ω–µ–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–∞–∫:
//

std::mutex mut;

void Increment()
{ 
    std::lock_guard lock(mut);
    
    for (int i = 0; i < 1000000; i++)
    { 
        number++;
    } 
}
```
üí°

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç unique_lock, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ, —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–±–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ—á–∏—Ç—å 1 –º—å—é—Ç–µ–∫—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ —Ä–∞–∑–ª–æ—á–∏–≤–∞—Ç—å –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏, –∏ —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã, —Ç.–µ. –æ–±–ª–∞—Å—Ç—å—é –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–∞–∫–æ–π RAII –æ–±—ë—Ä—Ç–∫–∏ —è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫–∞—è-–Ω–∏–±—É–¥—å –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## unique_lock
> –≠—Ç–æ –±–æ–ª–µ–µ–µ –ø—Ä–æ–∫–∞—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è lock_guard, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –∫–æ–≥–¥–∞ —É–≥–æ–¥–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å, —Ç–∞–∫–∂–µ –≤–ª–∞–¥–µ–Ω–∏–µ –º—å—é—Ç–µ–∫—Å–æ–º –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å.

```cpp
std::mutex mtx;
void Critical_section()
{
    std::unique_lock<std::mutex> lock(mtx);   	// –ó–∞—Ö–≤–∞—Ç –º—å—é—Ç–µ–∫—Å–∞

    //
    // –ö–æ–¥ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
    //

    lock.unlock(); 				// –Ø–≤–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞

    //
    // –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥
    //

    lock.lock(); 				// –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞

    //
    // –°–Ω–æ–≤–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥
    //
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –º—å—é—Ç–µ–∫—Å —Å—Ä–∞–∑—É).
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –º—å—é—Ç–µ–∫—Å –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É –≤–ª–∞–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–æ–º –¥—Ä—É–≥–æ–º—É `unique_lock`.
- –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `lock_guard` –∏–∑-–∑–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏.

## scoped_lock (C++17)
> –ú–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ —Å—Ä–∞–∑—É**, **–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è deadlock**. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é **–∞—Ç–æ–º–∞—Ä–Ω–æ**.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ deadlock.
- –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º—å—é—Ç–µ–∫—Å–∞.
- –û—á–µ–Ω—å —É–¥–æ–±–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º—å—é—Ç–µ–∫—Å–∞–º–∏.

```cpp
std::mutex mtx1, mtx2;
void critical_section() 
{
    std::scoped_lock lock(mtx1, mtx2);
    //
    // <-- –ö–æ–¥ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏, –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –¥–≤—É–º—è –º—å—é—Ç–µ–∫—Å–∞–º–∏
    //
}
```
üí°
–í—Å–ø–æ–º–∏–Ω–∞—è –ø—Ä–∏–º–µ—Ä –∏–∑ –≥–ª–∞–≤—ã –ø—Ä–æ **deadlock**, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ç–µ–ø–µ—Ä—å –≤–æ—Ç —Ç–∞–∫:

```cpp
std::mutex mtx1;
std::mutex mtx2;

void thread1() 
{
    std::scoped_lock lock(mtx1, mtx2); 				// –ó–∞—Ö–≤–∞—Ç –æ–±–æ–∏—Ö –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ
    std::cout << "Thread 1 has locked both mutexes.\n";
}

void thread2() 
{
    std::scoped_lock lock(mtx1, mtx2); 				// –ó–∞—Ö–≤–∞—Ç –æ–±–æ–∏—Ö –º—å—é—Ç–µ–∫—Å–æ–≤ –∞—Ç–æ–º–∞—Ä–Ω–æ
    std::cout << "Thread 2 has locked both mutexes.\n";
}

// int main...
```

## shared_mutex & shared_lock
> shared_mutex –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ **–ª–∏—à—å 1 –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**, –∞  **–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ª–∏—à—å —á–∏—Ç–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.**

```cpp
#include <iostream>
#include <thread>
#include <shared_mutex>
#include <map>
#include <string>

std::shared_mutex cache_mutex;
std::map<int, std::string> cache;

using shared_lock_t = std::shared_lock<std::shared_mutex>;
using unique_lock_t = std::unique_lock<std::unique_mutex>;

std::string GetFromCache(int key) 
{
    //
    // –ó–∞—Ö–≤–∞—Ç –≤ —Ä–µ–∂–∏–º–µ shared (–¥–ª—è —á—Ç–µ–Ω–∏—è)
    //

    shared_lock_t lock(cache_mutex); 
    if (cache.find(key) != cache.end()) {
        return cache[key]; 			// If found by key
    } 
    else {
        return "Not found";
    }
}

void UpdateCache(int key, const std::string& value) 
{
    //
    // –ó–∞—Ö–≤–∞—Ç –≤ —Ä–µ–∂–∏–º–µ exclusive (–¥–ª—è –∑–∞–ø–∏—Å–∏)
    // –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –≥–¥–µ –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ-—Ç–æ
    // .. –ø–æ–∫–∞ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –ø–æ—Ç–æ–∫–∏ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç
    // .. —Ç.–µ. –≤—Å–µ –ø–æ—Ç–æ–∫–∏ —Å–≤–æ–±–æ–¥–Ω–æ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é –¥—Ä—É–≥ –¥—Ä—É–≥–∞
    // .. –Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—â–∏–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å–µ–º —á–∏—Ç–∞—Ç—å
    // .. –ø–æ–∫–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ, –∞ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ —Ä–∞–∑—Ä–µ—à–∞—Ç –≤—Å–µ–º —á–∏—Ç–∞—Ç—å –¥–∞–ª—å—à–µ
    //

    unique_lock_t lock(cache_mutex);
    cache[key] = value;
}

void reader_thread(int key) 
{
    std::cout << "Reader thread: " << GetFromCache(key) << std::endl;
}

void writer_thread(int key, const std::string& value) 
{
    UpdateCache(key, value);
    std::cout << "Writer thread: updated key " << key  
              << " with value " << value << std::endl;
}

int main() 
{
    //
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
    //

    std::thread writer1(writer_thread, 1, "Data1");
    writer1.join();

    //
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞
    //

    std::thread reader1(reader_thread, 1);
    std::thread reader2(reader_thread, 1);
    reader1.join();
    reader2.join();

    //
    // –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º
    //

    std::thread writer2(writer_thread, 1, "NewData1");
    writer2.join();

    //
    // –ß—Ç–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    //

    std::thread reader3(reader_thread, 1);
    reader3.join();

    return 0;
}
```

–ï—Å–ª–∏ –±—ã –≤ –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ–±—ã—á–Ω—ã–π –º—å—é—Ç–µ–∫—Å, —Ç–æ —á—Ç–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –±—ã –∫—É–¥–∞ –¥–æ–ª—å—à–µ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —á—Ç–µ–Ω–∏–µ –∫–∞–∂–¥—ã–º –ø–æ—Ç–æ–∫–æ–º –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –±—ã –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏.

## recursive_mutex
> –≠—Ç–æ –º—å—é—Ç–µ–∫—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ö–≤–∞—á–µ–Ω –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –ø–æ—Ç–æ–∫–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è. –ü–æ–ª–µ–∑–µ–Ω –≤ —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è, —É–∂–µ –∑–∞—Ö–≤–∞—Ç–∏–≤—à–∞—è –º—å—é—Ç–µ–∫—Å, –≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Ç–æ—Ç –∂–µ –º—å—é—Ç–µ–∫—Å.

```cpp
std::recursive_mutex rec_mtx;

void RecursiveFunction(int count) 
{
    if (count <= 0) {
      return;
    } 
    
    std::lock_guard<std::recursive_mutex> lock(rec_mtx);
    std::cout << "Count: " << count << std::endl;
    
    RecursiveFunction(count - 1);
}

int main() 
{
    std::thread t1(RecursiveFunction, 3);
    t1.join();
}

```

## ‚Ä¶add
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º—å—é—Ç–µ–∫—Å–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö –∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∫—É–¥–∞ –±–æ–ª—å—à–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ Win32 Api –µ—Å—Ç—å SRWLock, –≤ UNIX - pthread_mutex, futex, pthread_rwlocck –∏ —Ç.–ø.
